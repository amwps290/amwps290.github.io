---
title: SQLite3 源码分析-sqlite_schema(sqlite_master) 的创建
author: amwps290
date: 2024-09-26 09:23
categories: [SQLITE,源码分析]
tags: [sqlite]
render_with_liquid: false
---


在 sqlite 初始化的过程中，会首先创建 `sqlite_schema(sqlite_master)` 这个表，然后执行 `select * from main.sqlite_master` 语句，将数据库中的的表，索引，视图，触发器等信息加载到 `sqlite->aDb->pSchema` 中。

整体结构图

```mermaid
graph LR
A[sqlite 初始化] --> B[创建 sqlite_master] --> C[读取 sqlite_master] --> D[加载数据到内存]
```


```mermaid
 gantt
  title  Adding GANTT diagram functionality to mermaid
  apple :a, 2017-07-20, 1w
  banana :crit, b, 2017-07-23, 1d
  cherry :active, c, after b a, 1d
``


根据 SQLite3 的[数据格式](https://www.sqlite.org/fileformat.html#b_tree_pages) 我们可以看到，在数据库文件中的第一个页面存在一个名字叫做 `sqlite_schema` 的表,这个表中会记录 sqlite 数据库中所有的表，索引，视图，以及触发器。这个表会在我们第一次对数据库进行操作的时候进行创建。这个表就相当于数据库中的一个元信息表，我们对数据库的任何 DDL(Data Definition Language，数据定义语言) 操作之前，都需要检查一下，这个数据库中是不是已经存在了相同名字的表。具体的函数就是在 `sqlite3ReadSchema`

<script src="https://gist.github.com/amwps290/92e27acaf41edd10d7ba272504dfc371.js"></script>


在这个函数中我们可以看到如果 `db.init.busy` 来判断数据库当前是否在初始化中，如果没有在初始化，那么我们就进行初始化。

<script src="https://gist.github.com/amwps290/686e9cf03aa80a4962b728cbafa4397b.js"></script>

在这个函数中，我们看到主要分为两个部分，一个是检查当前数据库是否已经将数据库中的表，索引等信息读取到内存中的哈希表，这个通过 `DB_SchemaLoaded` 来判断。如果不是最新的，我们就通过 `sqlite3InitOne` 来读取。在第二个 for 循环中功能也是一样的，用来读取数据库中的元数据。

<!-- markdownlint-capture -->
<!-- markdownlint-disable -->
> sqlite 中有两个数据库，一个是 main 数据库，用于储存长期数据，一个是 temp 数据库，用于存储一些临时的对象。
{: .prompt-tip }
<!-- markdownlint-restore -->

现在我们来**重点**看一下 `sqlite3InitOne` 函数：

<script src="https://gist.github.com/amwps290/5a04cfd0c06651adb058bf03db8b3fc1.js"></script>

在这个函数中，我们需要重点看一下：
1. 第 50 行，这里会调用一个 `sqliteInitCallback` 这个函数
2. 第 184 行，这里会调用 sqlite_exec 这个函数，这个会指定 sqliteInitCallback 作为回调函数

