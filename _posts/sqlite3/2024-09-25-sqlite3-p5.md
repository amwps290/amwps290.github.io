---
title: SQLite3 源码分析-数据格式
author: amwps290
date: 2024-11-18 00:00
categories: [SQLITE,源码分析]
tags: [sqlite]
mermaid: true
---

## 前记

这一篇我们将分析一下 SQlite3 的文件格式. 参考[链接](https://www.sqlite.org/fileformat.html).

我们需要用到一个[网站](https://torymur.github.io/sqlite-repr/),可以直观的展示 sqlite3 的格式,带有互动功能. 

同时我们还可以使用 sqlite 自带的一个 `showdb` 的工具来查看 sqlite 的数据库的一些信息.

## 格式分析

sqlite3 的数据文件被分成了固定大小的页面，然后页面之间通过一个页编号来进行互相引用。

其中页面可以被分为：自由页面(即未被使用的页面)，B 树页面，溢出页面。其他页面暂不说明。


### 数据库头



| 偏移量(字节) | 大小(字节) | 描述 |
|------------|-----------|------|
| 0-15 | 16 | 文件头字符串: "SQLite format 3\000" |
| 16-17 | 2 | 页大小(默认 4096),同时页面大小必须为 2 的次幂数,且范围为 512-32768, 如果是 1 的话,则页面大小为 65536 |
| 18 | 1 | 写入格式版本(1 或 2) |
| 19 | 1 | 读取格式版本(1 或 2) |
| 20 | 1 | 每页末尾保留的字节数(通常为 0) |
| 21 | 1 | 最大的嵌入负载的比例,必须为 64,这个指的是实际存储在页面中的数据的比例 |
| 22 | 1 | 最小的嵌入负载比例,必须为 32,这个指的是实际存储在页面中的数据的比例 |
| 23 | 1 | 叶子页面负载比例,必须为 32 |
| 24 | 4 | 文件修改计数器,即这个数据文件被修改过多少次 |
| 28 | 4 | 数据库大小(以页为单位) |
| 32 | 4 | 第一个自由页面(空闲页面)的大小，我们可以理解为被删除的表所占用的页面|
| 36 | 4 | 总的自由页面个数|
| 40 | 4 | schema cookie, 可以理解为用来记录数据库改动的一个参数，在前面我们创建表的时候就要读取这个参数|
| 44 | 4 | schema 格式类型，目前只有1，2，3，4 这四种,可能随着 sqlite3 的更新还会变化 |
| 48 | 4 | 默认页面缓存大小 |
| 52 | 4 | 在 vacuum 模式下，最大 b 树根页面的页码，否则为 0|
| 56 | 4 | 数据库文本编码格式,1 表示 UTF-8,2 表示 UTF-16LE, 3 表示 UTF-16BE |
| 60 | 4 | 一个可供用户修改的格式信心,可以使用 `PRAGMA schema.user_version = integer ;` 来修改|
| 64 | 4 | 如果不为 0 则表示 incremental-vacuum 模式,否则为 0 |
| 68 | 4 | 应用程序 ID, 一般可用于 file 命令来读取,当然也可以使用 `PRAGMA` 命令来修改适用于用户自己的文件类型|
| 72 | 20| 用于扩展,必须为 0 |
| 92 | 4 | 版本有效数字 |
| 96 | 4 | 最新修改数据文件的SQLite版本号|

我们可以在如下的网站中查看具体的信息:
![alt text](../assets/images/sqlite3_header.png)

### 自由页面





### B 树页面



### 溢出页面


### Varint 数据类型














## 后记

终于理解了 sqlite3 的数据格式了.😎
